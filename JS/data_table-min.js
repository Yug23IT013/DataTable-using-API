$(document).ready((function(){const e="https://glexas.com/hostel_data/API/test/new_admission_crud.php";let t;function a(){return $.ajax({url:e,type:"GET",dataType:"json"})}Swal.fire({title:"Loading Data",text:"Please wait...",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}}),a().then((e=>{Swal.close(),function(e){const a=e.response[0];let i="<tr>";Object.keys(a).forEach((e=>{"registration_main_id"!==e&&"created_time"!==e&&(i+=`<th>${e.replace(/_/g," ").replace(/\\b\\w/g,(e=>e.toUpperCase()))}</th>`)})),i+="<th>Actions</th></tr>",$("#admissionTable thead").html(i),t=$("#admissionTable").DataTable({data:e.response,dom:"Bfrtip",buttons:[{extend:"excel",text:"Excel",className:"btn btn-success btn-sm me-2",exportOptions:{columns:[0,1,2,3,4,5,6]},title:"Admission Data"},{extend:"csv",text:"CSV",className:"btn btn-info btn-sm me-2",exportOptions:{columns:[0,1,2,3,4,5,6]},title:"Admission Data"},{extend:"pdf",text:"PDF",className:"btn btn-danger btn-sm me-2",exportOptions:{columns:[0,1,2,3,4,5,6]},title:"Admission Data"},{extend:"print",text:"Print",className:"btn btn-secondary btn-sm",exportOptions:{columns:[0,1,2,3,4,5,6]},title:"Admission Data"}],columns:(()=>{const t=[],a=e.response[0];return Object.keys(a).forEach((e=>{"registration_main_id"!==e&&"created_time"!==e&&t.push({data:e})})),t.push({data:null,render:function(){return'\n                            <i class="bi bi-pencil-square editBtn" aria-label="Edit User"></i>\n                            <i class="bi bi-trash deleteBtn" aria-label="Delete User"></i>\n                        '}}),t})(),language:{buttons:{excel:"Export to Excel",csv:"Export to CSV",pdf:"Export to PDF",print:"Print Table"}}})}(e)})).catch((e=>{Swal.fire({icon:"error",title:"Error!",text:"Failed to load data. Please try again later."})})),window.reloadTableData=function(){Swal.fire({title:"Refreshing Data",text:"Please wait...",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}}),a().then((e=>{Swal.close(),t.clear(),t.rows.add(e.response).draw()})).catch((e=>{Swal.fire({icon:"error",title:"Error!",text:"Failed to refresh data. Please try again later."})}))},$("#addUserButton").click((function(){$("#admissionForm")[0].reset(),$("#registrationMainId").val(""),$("#admissionForm").validate().resetForm(),$("#admissionForm .form-control").removeClass("is-invalid is-valid"),$("#admissionModal").modal("show"),$("#phoneValidationMsg").text("")})),$("#admissionTable tbody").on("click",".editBtn",(function(){const e=t.row($(this).parents("tr")).data(),a=new Date(e.created_time),n=(new Date-a)/36e5;$("#phoneValidationMsg").text(""),n>=24?Swal.fire({icon:"warning",title:"Edit Disabled",text:"You cannot edit record after 1 day."}):($("#registrationMainId").val(e.registration_main_id),$("#userCode").val(e.user_code),$("#firstName").val(e.first_name),$("#middleName").val(e.middle_name),$("#lastName").val(e.last_name),$("#phoneInput").val(e.phone_number),$("#email").val(e.email),$("#admissionForm").validate().resetForm(),$("#admissionForm .form-control").removeClass("is-invalid is-valid"),$("#admissionModal").modal("show"),i.setNumber(e.phone_country_code+e.phone_number))})),$.validator.addMethod("validPhone",(function(e,t){var a=t,i=window.intlTelInputGlobals.getInstance(a);return!(!i||!i.isValidNumber())&&e.replace(/\D/g,"").length<15}),"Please enter a valid phone number"),$("#admissionForm").validate({rules:{userCode:{required:!0},firstName:{required:!0},lastName:{required:!0},phoneInput:{required:!0,validPhone:!0},email:{required:!0,email:!0}},messages:{userCode:"Please enter the user code",firstName:"Please enter first name",lastName:"Please enter last name",email:{required:"Please enter email",email:"Enter a valid email"}},errorClass:"is-invalid",validClass:"",errorElement:"div",errorPlacement:function(e,t){e.addClass("invalid-feedback"),e.insertAfter(t)},highlight:function(e){$(e).addClass("is-invalid").removeClass("is-valid")},unhighlight:function(e){$(e).removeClass("is-invalid").addClass("is-valid")}}),$("#admissionForm").submit((function(t){if(t.preventDefault(),!$("#admissionForm").valid())return;if(!i.isValidNumber())return void $("#phoneInput").addClass("is-invalid");const a=""!==$("#registrationMainId").val(),n=i.getNumber(),o="+"+i.getSelectedCountryData().dialCode,s={user_code:$("#userCode").val(),first_name:$("#firstName").val(),middle_name:$("#middleName").val(),last_name:$("#lastName").val(),phone_number:n.replace(o,""),phone_country_code:o,email:$("#email").val()};a&&(s.registration_main_id=$("#registrationMainId").val());const r=a?"PUT":"POST";"POST"===r?$.ajax({url:e,type:r,data:$.param(s),success:function(){$("#admissionModal").modal("hide"),reloadTableData(),Swal.fire({icon:"success",title:"Success!",text:"User has been added successfully",timer:2e3,showConfirmButton:!1})},error:function(){Swal.fire({icon:"error",title:"Error!",text:"Failed to save user data"})}}):"PUT"===r?$.ajax({url:e,type:r,contentType:"application/json",data:JSON.stringify(s),success:function(){$("#admissionModal").modal("hide"),reloadTableData(),Swal.fire({icon:"success",title:"Success!",text:"User has been updated successfully",timer:2e3,showConfirmButton:!1})},error:function(){Swal.fire({icon:"error",title:"Error!",text:"Failed to update user data"})}}):Swal.fire({icon:"error",title:"Error!",text:"Invalid method"})})),$("#admissionTable tbody").on("click",".deleteBtn",(function(){const a=t.row($(this).parents("tr")).data();Swal.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#FF0000",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it!"}).then((t=>{t.isConfirmed&&$.ajax({url:e,type:"DELETE",contentType:"application/json",data:JSON.stringify({registration_main_id:a.registration_main_id}),success:function(){reloadTableData(),Swal.fire({icon:"success",title:"Deleted!",text:"User has been deleted successfully",timer:2e3,showConfirmButton:!1})},error:function(){Swal.fire({icon:"error",title:"Error!",text:"Failed to delete user"})}})}))}));const i=window.intlTelInput(document.querySelector("#phoneInput"),{initialCountry:"auto",allowDropdown:!0,strictMode:!0,autoHideDialCode:!1,utilsScript:"https://cdn.jsdelivr.net/npm/intl-tel-input@21.1.1/build/js/utils.js",geoIpLookup:function(e){fetch("https://ipinfo.io/json").then((e=>e.json())).then((t=>e(t.country))).catch((()=>e("us")))}});$("#phoneInput").on("input",(function(){const e=document.querySelector("#phoneInput"),t=window.intlTelInputGlobals.getInstance(e),a=e.value.replace(/\D/g,"");t&&t.isValidNumber()&&a.length>=10?$("#phoneValidationMsg").css("color","green"):$("#phoneValidationMsg").css("color","red"),$("#admissionForm").validate().element(this)}))}));
