$(document).ready((function(){const e="https://glexas.com/hostel_data/API/test/new_admission_crud.php";let t;function a(){return $.ajax({url:e,type:"GET",dataType:"json"})}function i(e){const t=$("#admissionTable"),a=$("<thead>"),i=$("<tbody>"),n=$("<tr>"),s=e.response[0];Object.keys(s).forEach((e=>{if("registration_main_id"!==e&&"created_time"!==e){const t=$("<th>").text(e.replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase())));n.append(t)}})),n.append($("<th>").text("Actions")),a.append(n),e.response.forEach((e=>{const t=$("<tr>").attr("data-row",JSON.stringify(e));Object.keys(e).forEach((a=>{if("registration_main_id"!==a&&"created_time"!==a){const i=$("<td>").text(e[a]);t.append(i)}}));const a=$("<td>").html('\n                <div class="d-flex justify-content-center">\n                    <i class="bi bi-pencil-square editBtn" style="cursor: pointer; margin-right: 10px;" aria-label="Edit User"></i>\n                    <i class="bi bi-trash deleteBtn" style="cursor: pointer;" aria-label="Delete User"></i>\n                </div>\n            ');t.append(a),i.append(t)})),t.empty().append(a).append(i)}function n(a){i(a),t=$("#admissionTable").DataTable({dom:"Bfrtip",buttons:[{extend:"excel",text:"Excel",className:"btn btn-success btn-sm me-2",exportOptions:{columns:[0,1,2,3,4,5,6]},title:"Admission Data"},{extend:"csv",text:"CSV",className:"btn btn-info btn-sm me-2",exportOptions:{columns:[0,1,2,3,4,5,6]},title:"Admission Data"},{extend:"pdf",text:"PDF",className:"btn btn-danger btn-sm me-2",exportOptions:{columns:[0,1,2,3,4,5,6]},title:"Admission Data"},{extend:"print",text:"Print",className:"btn btn-secondary btn-sm",exportOptions:{columns:[0,1,2,3,4,5,6]},title:"Admission Data"}],language:{buttons:{excel:"Export to Excel",csv:"Export to CSV",pdf:"Export to PDF",print:"Print Table"}},drawCallback:function(){$("#admissionTable tbody").off("click",".editBtn").on("click",".editBtn",(function(){const e=$(this).closest("tr"),t=JSON.parse(e.attr("data-row")),a=new Date(t.created_time),i=(new Date-a)/36e5;$("#phoneValidationMsg").text(""),i>=24?Swal.fire({icon:"warning",title:"Edit Disabled",text:"You cannot edit record after 1 day."}):($("#registrationMainId").val(t.registration_main_id),$("#userCode").val(t.user_code),$("#firstName").val(t.first_name),$("#middleName").val(t.middle_name),$("#lastName").val(t.last_name),$("#phoneInput").val(t.phone_number),$("#email").val(t.email),$("#admissionForm").validate().resetForm(),$("#admissionForm .form-control").removeClass("is-invalid is-valid"),$("#admissionModal").modal("show"),s.setNumber(t.phone_country_code+t.phone_number))})),$("#admissionTable tbody").off("click",".deleteBtn").on("click",".deleteBtn",(function(){const t=$(this).closest("tr"),a=JSON.parse(t.attr("data-row"));Swal.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#FF0000",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it!"}).then((t=>{t.isConfirmed&&$.ajax({url:e,type:"DELETE",contentType:"application/json",data:JSON.stringify({registration_main_id:a.registration_main_id}),success:function(){reloadTableData(),Swal.fire({icon:"success",title:"Deleted!",text:"User has been deleted successfully",timer:2e3,showConfirmButton:!1})},error:function(){Swal.fire({icon:"error",title:"Error!",text:"Failed to delete user"})}})}))}))}})}Swal.fire({title:"Loading Data",text:"Please wait...",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}}),a().then((e=>{Swal.close(),n(e)})).catch((e=>{Swal.fire({icon:"error",title:"Error!",text:"Failed to load data. Please try again later."})})),window.reloadTableData=function(){Swal.fire({title:"Refreshing Data",text:"Please wait...",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}}),a().then((e=>{Swal.close(),$.fn.DataTable.isDataTable("#admissionTable")&&$("#admissionTable").DataTable().destroy(),i(e),n(e)})).catch((e=>{Swal.fire({icon:"error",title:"Error!",text:"Failed to refresh data. Please try again later."})}))},$("#addUserButton").click((function(){$("#admissionForm")[0].reset(),$("#registrationMainId").val(""),$("#admissionForm").validate().resetForm(),$("#admissionForm .form-control").removeClass("is-invalid is-valid"),$("#admissionModal").modal("show"),$("#phoneValidationMsg").text("")})),$.validator.addMethod("validPhone",(function(e,t){var a=t,i=window.intlTelInputGlobals.getInstance(a);return!(!i||!i.isValidNumber())&&e.replace(/\D/g,"").length<15}),"Please enter a valid phone number"),$("#admissionForm").validate({rules:{userCode:{required:!0},firstName:{required:!0},lastName:{required:!0},phoneInput:{required:!0,validPhone:!0},email:{required:!0,email:!0}},messages:{userCode:"Please enter the user code",firstName:"Please enter first name",lastName:"Please enter last name",email:{required:"Please enter email",email:"Enter a valid email"}},errorClass:"is-invalid",validClass:"",errorElement:"div",errorPlacement:function(e,t){e.addClass("invalid-feedback"),e.insertAfter(t)},highlight:function(e){$(e).addClass("is-invalid").removeClass("is-valid")},unhighlight:function(e){$(e).removeClass("is-invalid").addClass("is-valid")}}),$("#admissionForm").submit((function(t){if(t.preventDefault(),!$("#admissionForm").valid())return;if(!s.isValidNumber())return void $("#phoneInput").addClass("is-invalid");const o=""!==$("#registrationMainId").val(),r=s.getNumber(),l="+"+s.getSelectedCountryData().dialCode,d={user_code:$("#userCode").val(),first_name:$("#firstName").val(),middle_name:$("#middleName").val(),last_name:$("#lastName").val(),phone_number:r.replace(l,""),phone_country_code:l,email:$("#email").val()};o&&(d.registration_main_id=$("#registrationMainId").val());const c=o?"PUT":"POST";"POST"===c?$.ajax({url:e,type:c,data:$.param(d),success:function(){$("#admissionModal").modal("hide"),$.fn.DataTable.isDataTable("#admissionTable")&&$("#admissionTable").DataTable().destroy(),a().then((e=>{i(e),n(e)})),Swal.fire({icon:"success",title:"Success!",text:"User has been added/updated successfully",timer:2e3,showConfirmButton:!1})},error:function(){Swal.fire({icon:"error",title:"Error!",text:"Failed to save user data"})}}):"PUT"===c?$.ajax({url:e,type:c,contentType:"application/json",data:JSON.stringify(d),success:function(){$("#admissionModal").modal("hide"),$.fn.DataTable.isDataTable("#admissionTable")&&$("#admissionTable").DataTable().destroy(),a().then((e=>{i(e),n(e)})),Swal.fire({icon:"success",title:"Success!",text:"User has been updated successfully",timer:2e3,showConfirmButton:!1})},error:function(){Swal.fire({icon:"error",title:"Error!",text:"Failed to update user data"})}}):Swal.fire({icon:"error",title:"Error!",text:"Invalid method"})}));const s=window.intlTelInput(document.querySelector("#phoneInput"),{initialCountry:"auto",allowDropdown:!0,strictMode:!0,autoHideDialCode:!1,utilsScript:"https://cdn.jsdelivr.net/npm/intl-tel-input@21.1.1/build/js/utils.js",geoIpLookup:function(e){fetch("https://ipinfo.io/json").then((e=>e.json())).then((t=>e(t.country))).catch((()=>e("us")))}});$("#phoneInput").on("input",(function(){const e=document.querySelector("#phoneInput"),t=window.intlTelInputGlobals.getInstance(e),a=e.value.replace(/\D/g,"");t&&t.isValidNumber()&&a.length>=10?$("#phoneValidationMsg").css("color","green"):$("#phoneValidationMsg").css("color","red"),$("#admissionForm").validate().element(this)}))}));
